---
eip: 140
title: REVERT指令
author: Alex Beregszaszi (@axic), Nikolai Mushegian <nikolai@nexusdev.us>
type: Standards Track
category: Core
status: Final
created: 2017-02-06
---

## 简单概要

`REVERT`指令提供了一种停止执行并恢复原状态的方式，且不会将提供的所有的gas都消耗掉，而且还提供了返回一个表示原因的值的方法。

## 摘要

`REVERT`指令将停止执行，回滚所有的状态修改并返回一个指向内存区域的指针，该指针指向内容是错误代号和错误信息。当指令执行的时候，不会消耗掉所有的剩余gas。

## 目的

目前没有提供任何方式来达到这一点。目前两个常用的复原一个合约交易的方式是：耗光所有的gas或执行一个无效的指令。其中的任何一种都会消耗掉剩余的所有gas。复原一个EVM执行意味着，包括LOGs在内的所有的修改都会丢失并且没有方法传递中止EVM执行的原因。

## 规范

On blocks with `block.number >= BYZANTIUM_FORK_BLKNUM`, the `REVERT` instruction is introduced at `0xfd`. It expects two stack items, the top item is the `memory_offset` followed by `memory_length`. It does not produce any stack elements because it stops execution.

The semantics of `REVERT` with respect to memory and memory cost are identical to those of `RETURN`. The sequence of bytes given by `memory_offset` and `memory_length` is called "error message" in the following.

The effect of `REVERT` is that execution is aborted, considered as failed, and state changes are rolled back. The error message will be available to the caller in the returndata buffer and will also be copied to the output area, i.e. it is handled in the same way as the regular return data is handled.

The cost of the `REVERT` instruction equals to that of the `RETURN` instruction, i.e. the rollback itself does not consume all gas, the contract only has to pay for memory.

In case there is not enough gas left to cover the cost of `REVERT` or there is a stack underflow, the effect of the `REVERT` instruction will equal to that of a regular out of gas exception, i.e. it will consume all gas.

In the same way as all other failures, the calling opcode returns `0` on the stack following a `REVERT` opcode in the callee.

In case `REVERT` is used in the context of a `CREATE` or `CREATE2` call, no code is deployed, `0` is put on the stack and the error message is available in the returndata buffer.

The content of the optionally provided memory section is not defined by this EIP, but is a candidate for another Informational EIP.

## 向后兼容

This change has no effect on contracts created in the past unless they contain `0xfd` as an instruction.

## 测试用例

```
6c726576657274656420646174616000557f726576657274206d657373616765000000000000000000000000000000000000600052600e6000fd
```

should:
- return `0x726576657274206d657373616765` as `REVERT` data,
- the storage at key `0x0` should be left as unset and
- use 20024 gas in total.

## 版权

版权及相关权利由此[CC0](https://creativecommons.org/publicdomain/zero/1.0/)声明弃权。